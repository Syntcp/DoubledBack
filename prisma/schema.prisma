generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")

}

enum RepoProvider {
  GITHUB
  GITLAB
  OTHER
}

model User {
  id           BigInt   @id @default(autoincrement())
  email        String   @unique @db.VarChar(191)
  fullName     String
  jobTitle     String?
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  roles         UserRole[]
  refreshTokens RefreshToken[]
  activityLogs  ActivityLog[]  @relation("ActorLogs")

  Client Client[]

  profile  OwnerProfile?
  invoices Invoice[]

  Expense Expense[]

  workflowSteps WorkflowStep[]
}

model Client {
  id        BigInt   @id @default(autoincrement())
  fullName  String
  email     String?  @db.VarChar(191)
  phone     String?  @db.VarChar(32)
  company   String?  @db.VarChar(191)
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerId BigInt?
  owner   User?   @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  projects Project[]
  websites Websites[]

  invoices Invoice[]

  @@index([ownerId])
  @@index([email])
}

model Project {
  id             BigInt        @id @default(autoincrement())
  clientId       BigInt
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  repoProvider   RepoProvider?
  repoUrl        String?       @db.VarChar(255)
  repoOwner      String?       @db.VarChar(100)
  repoName       String?       @db.VarChar(100)
  defaultBranch  String?       @db.VarChar(64)
  liveUrl        String?       @db.VarChar(255)
  healthUrl      String?       @db.VarChar(255)
  lastRepoPushAt DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([clientId])
  projectWorkflows ProjectWorkflow[]
}

model Websites {
  id          BigInt @id @default(autoincrement())
  clientId    BigInt
  client      Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name        String
  logo        String
  url         String
  description String
  techStack   Json // Exemple : ["Vue.js", "Nuxt.js", "Bootstrap"],
  media       String
  category    String
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  CASH
  CHECK
  OTHER
}

model OwnerProfile {
  id                 BigInt   @id @default(autoincrement())
  ownerId            BigInt   @unique
  owner              User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  companyName        String
  fullName           String?
  addressLine1       String?
  addressLine2       String?
  postalCode         String?  @db.VarChar(32)
  city               String?  @db.VarChar(191)
  country            String?  @db.VarChar(191)
  email              String?  @db.VarChar(191)
  phone              String?  @db.VarChar(64)
  vatNumber          String?  @db.VarChar(64)
  taxId              String?  @db.VarChar(64)
  registrationNumber String?  @db.VarChar(64)
  website            String?  @db.VarChar(191)
  logoUrl            String?  @db.VarChar(255)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Invoice {
  id          BigInt        @id @default(autoincrement())
  ownerId     BigInt
  owner       User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  clientId    BigInt
  client      Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  number      String        @db.VarChar(64)
  issueDate   DateTime
  dueDate     DateTime
  currency    String        @default("EUR") @db.VarChar(8)
  status      InvoiceStatus @default(DRAFT)
  sentAt      DateTime?
  cancelledAt DateTime?
  notes       String?
  terms       String?
  subtotal    Decimal       @default(0) @db.Decimal(12, 2)
  taxTotal    Decimal       @default(0) @db.Decimal(12, 2)
  total       Decimal       @default(0) @db.Decimal(12, 2)
  paidAmount  Decimal       @default(0) @db.Decimal(12, 2)
  balanceDue  Decimal       @default(0) @db.Decimal(12, 2)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  items              InvoiceItem[]
  payments           Payment[]
  events             InvoiceStatusEvent[]
  ExpenseInvoiceLink ExpenseInvoiceLink[]

  @@unique([ownerId, number])
  @@index([clientId])
  @@index([ownerId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceItem {
  id          BigInt   @id @default(autoincrement())
  invoiceId   BigInt
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Decimal  @default(1) @db.Decimal(12, 2)
  unitPrice   Decimal  @db.Decimal(12, 2)
  taxRate     Decimal  @default(0) @db.Decimal(5, 2)
  total       Decimal  @default(0) @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([invoiceId])
}

model Payment {
  id         BigInt        @id @default(autoincrement())
  invoiceId  BigInt
  invoice    Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  amount     Decimal       @db.Decimal(12, 2)
  method     PaymentMethod @default(OTHER)
  reference  String?       @db.VarChar(191)
  receivedAt DateTime      @default(now())
  notes      String?
  createdAt  DateTime      @default(now())

  @@index([invoiceId])
}

model InvoiceStatusEvent {
  id         BigInt         @id @default(autoincrement())
  invoiceId  BigInt
  invoice    Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  fromStatus InvoiceStatus?
  toStatus   InvoiceStatus
  reason     String?
  createdAt  DateTime       @default(now())

  @@index([invoiceId])
}

// Expenses (owner's own bills/costs)

enum ExpenseFrequency {
  ONE_OFF
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
}

model Expense {
  id          BigInt           @id @default(autoincrement())
  ownerId     BigInt
  owner       User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  vendor      String
  description String?
  amount      Decimal          @db.Decimal(12, 2)
  currency    String           @default("EUR") @db.VarChar(8)
  frequency   ExpenseFrequency @default(ONE_OFF)
  startDate   DateTime         @default(now())
  endDate     DateTime?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  invoiceLinks ExpenseInvoiceLink[]

  @@index([ownerId])
  @@index([frequency])
  @@index([startDate])
}

model ExpenseInvoiceLink {
  id        BigInt   @id @default(autoincrement())
  expenseId BigInt
  expense   Expense  @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  invoiceId BigInt
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  allocated Decimal? @db.Decimal(12, 2)
  createdAt DateTime @default(now())

  @@unique([expenseId, invoiceId])
  @@index([expenseId])
  @@index([invoiceId])
}

model Role {
  id          BigInt           @id @default(autoincrement())
  name        String           @unique @db.VarChar(191)
  description String?
  users       UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          BigInt           @id @default(autoincrement())
  code        String           @unique @db.VarChar(191)
  description String?
  roles       RolePermission[]
}

model UserRole {
  userId BigInt
  roleId BigInt
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
}

model RolePermission {
  roleId       BigInt
  permissionId BigInt
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    BigInt
  tokenHash String    @unique @db.Char(64) // SHA-256 hex du refresh token
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model ActivityLog {
  id          BigInt   @id @default(autoincrement())
  actorUserId BigInt?
  entityType  String   @db.VarChar(64) // "user","role","permission", etc.
  entityId    BigInt?
  action      String   @db.VarChar(64) // "create","update","delete","login","logout"
  ip          String?  @db.VarChar(64)
  userAgent   String?
  method      String?  @db.VarChar(10)
  metadata    Json
  createdAt   DateTime @default(now())

  actor User? @relation("ActorLogs", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([createdAt])
}

enum WorkflowStatus {
  NOT_STARTED
  IN_PROGRESS
  DONE
}

enum WorkflowStepStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
}

enum WorkflowStepKind {
  INTERNAL
  CLIENT_CONTENT
}

enum ContentType {
  TEXT
  IMAGE
  VIDEO
  DOCUMENT
  OTHER
}

enum ContentStatus {
  REQUESTED
  PARTIAL
  RECEIVED
  APPROVED
}

model WorkflowTemplate {
  id        BigInt                 @id @default(autoincrement())
  name      String
  description String?
  type      String?                @db.VarChar(64)
  isActive  Boolean                @default(true)
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  steps            WorkflowStepTemplate[]
  projectWorkflows ProjectWorkflow[]

  @@index([isActive])
}

model WorkflowStepTemplate {
  id          BigInt           @id @default(autoincrement())
  templateId  BigInt
  template    WorkflowTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  title       String
  description String?
  order       Int
  kind        WorkflowStepKind @default(INTERNAL)
  required    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  steps WorkflowStep[]

  @@index([templateId])
  @@index([order])
}

model ProjectWorkflow {
  id        BigInt         @id @default(autoincrement())
  projectId BigInt         @unique
  project   Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  templateId BigInt?
  template   WorkflowTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  status    WorkflowStatus @default(NOT_STARTED)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  steps WorkflowStep[]

  @@index([templateId])
  @@index([status])
}

model WorkflowStep {
  id                BigInt              @id @default(autoincrement())
  projectWorkflowId BigInt
  projectWorkflow   ProjectWorkflow     @relation(fields: [projectWorkflowId], references: [id], onDelete: Cascade)
  templateStepId    BigInt?
  templateStep      WorkflowStepTemplate? @relation(fields: [templateStepId], references: [id], onDelete: SetNull)
  title             String
  description       String?
  order             Int
  kind              WorkflowStepKind    @default(INTERNAL)
  status            WorkflowStepStatus  @default(TODO)
  required          Boolean             @default(true)
  dueDate           DateTime?
  completedAt       DateTime?
  responsibleUserId BigInt?
  responsibleUser   User?               @relation(fields: [responsibleUserId], references: [id], onDelete: SetNull)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  contentItems ContentItem[]

  @@index([projectWorkflowId])
  @@index([templateStepId])
  @@index([responsibleUserId])
  @@index([status])
  @@index([order])
}

model ContentItem {
  id          BigInt        @id @default(autoincrement())
  stepId      BigInt
  step        WorkflowStep  @relation(fields: [stepId], references: [id], onDelete: Cascade)
  label       String
  type        ContentType   @default(TEXT)
  status      ContentStatus @default(REQUESTED)
  isBlocking  Boolean       @default(true)
  requestedAt DateTime      @default(now())
  receivedAt  DateTime?
  value       Json?
  externalUrl String?       @db.VarChar(255)
  fileUrl     String?       @db.VarChar(255)

  @@index([stepId])
  @@index([status])
}
