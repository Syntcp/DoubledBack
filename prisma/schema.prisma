generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum RepoProvider {
  GITHUB
  GITLAB
  OTHER
}

model User {
  id           BigInt   @id @default(autoincrement())
  email        String   @unique @db.VarChar(191)
  fullName     String
  jobTitle     String?
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  roles         UserRole[]
  refreshTokens RefreshToken[]
  activityLogs  ActivityLog[] @relation("ActorLogs")

  Client Client[]
}

model Client {
  id        BigInt   @id @default(autoincrement())
  fullName  String
  email     String?  @db.VarChar(191)
  phone     String?  @db.VarChar(32)
  company   String?  @db.VarChar(191)
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerId BigInt?
  owner   User? @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  projects Project[]

  @@index([ownerId])
  @@index([email])
}

model Project {
  id            BigInt       @id @default(autoincrement())
  clientId      BigInt
  client        Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  repoProvider  RepoProvider?
  repoUrl       String?      @db.VarChar(255)
  repoOwner     String?      @db.VarChar(100)
  repoName      String?      @db.VarChar(100)
  defaultBranch String?      @db.VarChar(64)
  liveUrl       String?      @db.VarChar(255)
  healthUrl     String?      @db.VarChar(255)
  lastRepoPushAt DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([clientId])
}

model Role {
  id          BigInt   @id @default(autoincrement())
  name        String   @unique @db.VarChar(191)
  description String?
  users       UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          BigInt   @id @default(autoincrement())
  code        String   @unique @db.VarChar(191)
  description String?
  roles       RolePermission[]
}

model UserRole {
  userId BigInt
  roleId BigInt
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
}

model RolePermission {
  roleId       BigInt
  permissionId BigInt
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model RefreshToken {
  id         String   @id @default(cuid())
  userId     BigInt
  tokenHash  String   @unique @db.Char(64) // SHA-256 hex du refresh token
  expiresAt  DateTime
  revokedAt  DateTime?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model ActivityLog {
  id          BigInt   @id @default(autoincrement())
  actorUserId BigInt?
  entityType  String   @db.VarChar(64) // "user","role","permission", etc.
  entityId    BigInt?
  action      String   @db.VarChar(64) // "create","update","delete","login","logout"
  ip          String?  @db.VarChar(64)
  userAgent   String?
  metadata    Json
  createdAt   DateTime @default(now())

  actor User? @relation("ActorLogs", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([createdAt])
}
